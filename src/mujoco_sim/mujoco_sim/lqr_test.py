import numpy as np
from scipy.linalg import solve_discrete_are, expm

# -----------------------
# 定义小车倒立摆物理参数
# -----------------------
R = 0.151 / 2               # 车轮半径
D = 0.42                    # 左右轮距离
l = 0.2                     # 摆杆质心到转轴距离
m = 0.4842                  # 车轮质量
M = 10.6316                 # 摆杆质量
I = 0.5 * m * R**2          # 车轮转动惯量
Jz = (1/3) * M * l**2       # 摆杆俯仰方向惯量
Jy = (1/12) * M * D**2      # 偏航方向惯量
g = 9.8

Q_eq = Jz * M + (Jz + M * l**2) * (2 * m + (2 * I) / R**2)

# -----------------------
# 连续时间系统矩阵
# -----------------------
A_23 = -(M**2 * l**2 * g) / Q_eq
A_43 = M * l * g * (M + 2 * m + (2 * I) / R**2) / Q_eq

A = np.array([
    [0, 1, 0, 0],
    [0, 0, A_23, 0],
    [0, 0, 0, 1],
    [0, 0, A_43, 0]
])

B_21 = (Jz + M * l**2 + M * l * R) / (Q_eq * R)
B_41 = -((M * l / R) + M + 2 * m + (2 * I) / R**2) / Q_eq

B = np.array([
    [0],
    [2 * B_21],
    [0],
    [2 * B_41]
])

# -----------------------
# 权重矩阵
# -----------------------
Q = np.diag([100, 1, 1000, 1])
R = np.array([[5]])

# -----------------------
# 离散化系统 
# -----------------------
dt = 0.01  # 采样时间 100Hz

n = A.shape[0]
M_exp = np.zeros((n + B.shape[1], n + B.shape[1]))
M_exp[:n, :n] = A * dt
M_exp[:n, n:] = B * dt

expM = expm(M_exp)
A_d = expM[:n, :n]
B_d = expM[:n, n:]

# -----------------------
# 求解离散代数黎卡提方程 DARE
# -----------------------
P_d = solve_discrete_are(A_d, B_d, Q, R)

# -----------------------
# 离散 LQR 增益
# -----------------------
K_d = np.linalg.inv(B_d.T @ P_d @ B_d + R) @ (B_d.T @ P_d @ A_d)

print("离散LQR反馈增益矩阵 K_d =")
print(K_d)
